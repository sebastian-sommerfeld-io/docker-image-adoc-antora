---
name: Auto-generate docs

on:
  push:
    branches: [ "main", "feat/*", "release/*" ]

permissions:
  contents: read

jobs:
  README:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: README.adoc
        run: |
          echo '= Docker Image: adoc-antora' > README.adoc
          {
            cat docs/modules/ROOT/partials/vars.adoc
            echo
            echo "// +-----------------------------------------+"
            echo "// |                                         |"
            echo "// |    DO NOT EDIT DIRECTLY !!!!!           |"
            echo "// |                                         |"
            echo "// |    File is auto-generated by pipline    |"
            echo "// |    Contents are based on Antora docs    |"
            echo "// |                                         |"
            echo "// +-----------------------------------------+"
            echo
            cat docs/modules/ROOT/partials/README.adoc
            echo
          } >> README.adoc

          cat README.adoc
        shell: bash
      - name: Commit and push
        uses: EndBug/add-and-commit@v9
        with:
          author_name: sebastian
          author_email: sebastian@sommerfeld.io
          message: "[Actions Bot] docs: auto-generated adoc contents"
          add: README.adoc

  antora-yml:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: README

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Print Branchname
        run: echo ${{github.ref}}

      - name: Adjust version from 'main' to '<branchname>' or to '<version>' for release branches (if not already correct)
        if: contains(github.ref, 'refs/heads/feat/') || contains(github.ref, 'refs/heads/release/')
        run: |
          BRANCH="${{github.ref}}"

          old="refs/heads/"
          BRANCH="${BRANCH//$old/}"

          # antora does not allow slashes in versions
          old="/"
          new="__"
          BRANCH="${BRANCH/$old/$new}"

          # remove the prefix for release branches
          old="release__"
          BRANCH="${BRANCH/$old/}"

          oldPattern='version: '
          new="version: $BRANCH"
          sed -i "/$oldPattern/s/.*/$new/" docs/antora.yml

          cat docs/antora.yml
        shell: bash
      - name: Adjust version from '<branchname>' to 'main' if not already correct ... run on main branch
        if: github.ref == 'refs/heads/main'
        run: |
          oldPattern='version: '
          new='version: main'
          sed -i "/$oldPattern/s/.*/$new/" docs/antora.yml

          cat docs/antora.yml
        shell: bash

      - name: Run yamllint for docs/antora.yml
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: docs/antora.yml

      - name: Commit and push
        uses: EndBug/add-and-commit@v9
        with:
          author_name: sebastian
          author_email: sebastian@sommerfeld.io
          message: "[Actions Bot] refactor: set antora version to branchname"
          add: docs/antora.yml

  update-linter-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: README

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Download latest linter rules from infrastructure repo (main branch)
        run: |
          echo "Download latest linter definitions"
          linterDefinitions=(
            '.asciidoc-link-check.json'
          )
          for file in "${linterDefinitions[@]}"; do
            echo "Download $file"
            rm "$file"
            curl -sL "https://raw.githubusercontent.com/sebastian-sommerfeld-io/infrastructure/main/resources/common-assets/linters/$file" -o "$file"
            git add "$file"
          done
        shell: bash
      - name: Commit and push
        uses: EndBug/add-and-commit@v9
        with:
          author_name: sebastian
          author_email: sebastian@sommerfeld.io
          message: "[Actions Bot] refactor: auto-updated linter rules"

  check-links-in-adoc-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: update-linter-rules

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: Install asciidoc-link-check
        run: npm ci
      - name: Validate links in all adoc files
        run: find . -name '*.adoc' -exec asciidoc-link-check -c .asciidoc-link-check.json -p {} \;

  on-failure:
    runs-on: ubuntu-latest
    needs: ['README', 'antora-yml', 'update-linter-rules', 'check-links-in-adoc-files']
    if: failure()

    steps:
      - name: Send pipeline status to Slack
        if: always()
        uses: kpritam/slack-job-status-action@v1
        with:
          job-status: ${{ job.status }}
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: C0438TFQNPM # pipelines channel
